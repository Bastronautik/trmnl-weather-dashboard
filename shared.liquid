{% assign current_temp = current.temperature_2m | round %}
{% assign current_weather_code = current.weather_code %}
{% assign today_max = daily.temperature_2m_max[0] | round %}
{% assign today_min = daily.temperature_2m_min[0] | round %}
{% assign color_mode = trmnl.plugin_settings.custom_fields_values.color_mode | default: "dark" %}
{% assign location = trmnl.plugin_settings.custom_fields_values.location | default: "Home" %}
{% assign utc = trmnl.system.timestamp_utc %}
{% assign offset = trmnl.user.utc_offset %}

{% assign local_timestamp = utc | plus: offset %}
{% assign current_time = local_timestamp | date: "%H:%M:%S"  %}

<script>
  const gridMap = {
    '0': [2,3,4,6,10,11,12,15,16,18,20,21,24,25,26,30,32,33,34],
    '1': [3,7,8,13,18,23,28,32,33,34],
    '2': [2,3,4,6,10,15,19,23,27,31,32,33,34,35],
    '3': [2,3,4,6,10,15,18,19,25,26,30,32,33,34],
    '4': [4,8,9,12,14,16,19,21,22,23,24,25,29,34],
    '5': [1,2,3,4,5,6,11,16,17,18,19,25,30,31,32,33,34],
    '6': [2,3,4,6,11,16,17,18,19,21,25,26,30,32,33,34],
    '7': [1,2,3,4,5,10,14,18,23,28,33],
    '8': [2,3,4,6,10,11,15,17,18,19,21,25,26,30,32,33,34],
    '9': [2,3,4,6,10,11,15,17,18,19,20,25,26,30,32,33,34],
    'a': [2,3,4,6,10,11,15,16,17,18,19,20,21,25,26,30,31,35],
    'b': [1,2,3,4,6,10,11,15,16,17,18,19,21,25,26,30,31,32,33,34],
    'c': [2,3,4,6,10,11,16,21,26,30,32,33,34],
    'd': [1,2,3,4,6,10,11,15,16,20,21,25,26,30,31,32,33,34],
    'e': [1,2,3,4,5,6,11,16,17,18,19,21,26,31,32,33,34,35],
    'f': [1,2,3,4,5,6,11,16,17,18,19,21,26,31],
    'g': [2,3,4,6,10,11,16,18,19,20,21,25,26,30,,32,33,34],
    'h': [1,5,6,10,11,15,16,17,18,19,20,21,25,26,30,31,35],
    'i': [2,3,4,8,13,18,23,28,32,33,34],
    'j': [2,3,4,5,10,15,20,21,25,26,30,32,33,34],
    'k': [1,5,6,10,11,14,16,17,18,21,24,26,30,31,35],
    'l': [1,6,11,16,21,26,31,32,33,34,35],
    'm': [1,5,6,7,9,10,11,13,15,16,20,21,25,26,30,31,35],
    'n': [1,5,6,10,11,12,15,16,18,20,21,24,25,26,30,31,35],
    'o': [2,3,4,6,10,11,15,16,20,21,25,26,30,32,33,34],
    'p': [1,2,3,4,6,10,11,15,16,17,18,19,21,26,31],
    'q': [2,3,4,6,10,11,15,16,20,21,23,25,26,29,30,32,33,34,35],
    'r': [1,2,3,4,6,10,11,15,16,17,18,19,21,25,26,30,31,35],
    's': [2,3,4,6,10,11,17,18,19,25,26,30,32,33,34],
    't': [1,2,3,4,5,8,13,18,23,28,33],
    'u': [1,5,6,10,11,15,16,20,21,25,26,30,32,33,34],
    'v': [1,5,6,10,11,15,16,20,21,25,27,29,33],
    'w': [1,5,6,10,11,15,16,20,21,23,25,26,27,29,30,31,35],
    'x': [1,5,6,10,12,14,18,22,24,26,30,31,35],
    'y': [1,5,6,10,12,14,18,23,28,33],
    'z': [1,2,3,4,5,10,14,18,22,26,31,32,33,34,35],
    '°': [3,7,9,13],
    '-': [17,18,19],
    '↑': [8,12,13,14,16,18,20,23,28],
    '↓': [8,13,16,18,20,22,23,24,28]
  };

  function renderDigit(digit, width = 30) {
    const digitStr = String(digit).toLowerCase();
    const activeRects = gridMap[digitStr] || [];

    // Generate rectangles for 5x7 grid (35 total)
    let rects = '';
    for (let row = 0; row < 7; row++) {
      for (let col = 0; col < 5; col++) {
        const rectNum = row * 5 + col + 1;
        const isActive = activeRects.includes(rectNum);
        const className = isActive ? 'number-on' : 'number-off';
        const x = col * 12;
        const y = row * 12;
        rects += `<rect class="${className}" x="${x}" y="${y}" width="10" height="10" rx="3"/>`;
      }
    }

    return `<svg width="${width}px" class="image-dither" viewBox="0 0 58 82" fill="none" xmlns="http://www.w3.org/2000/svg">${rects}</svg>`;
  }

  // Weather code to description mapping (WMO Weather interpretation codes)
  function getWeatherDescription(code) {
    const weatherCodes = {
      0: 'clear',
      1: 'clear',
      2: 'partly cloudy',
      3: 'cloudy',
      45: 'foggy',
      48: 'foggy',
      51: 'drizzle',
      53: 'drizzle',
      55: 'drizzle',
      56: 'freezing drizzle',
      57: 'freezing drizzle',
      61: 'rain',
      63: 'rain',
      65: 'heavy rain',
      66: 'freezing rain',
      67: 'freezing rain',
      71: 'snow',
      73: 'snow',
      75: 'heavy snow',
      77: 'snow grains',
      80: 'rain showers',
      81: 'rain showers',
      82: 'heavy rain',
      85: 'snow showers',
      86: 'heavy snow',
      95: 'thunderstorm',
      96: 'thunderstorm',
      99: 'thunderstorm'
    };
    return weatherCodes[code] || 'unknown';
  }

  function getDayName(dateString) {
    const days = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
    const date = new Date(dateString);
    return days[date.getDay()];
  }
</script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.10/css/weather-icons.min.css">
<style>

  .layout {
    font-family: "Roboto Mono";  
  }

  .day-name {
    font-weight: bold;
    text-transform: uppercase;
  }

  .location-name {
    text-transform: uppercase;
  }

  .dark .number-on {
    fill: #FFFFFF;
  }

  .dark .number-off {
    fill: #232323;
  }

  .light .number-on {
    fill: #000000;
  }

  .light .number-off {
    fill: #D9D9D9;
  }

  .icon-on {
    opacity: 1;
  }

  .icon-off {
    opacity: 0.2;
  }
</style>